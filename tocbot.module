<?php

/**
 * Implements hook_menu().
 */
function tocbot_menu() {
  $items['admin/config/content/default'] = array(
    'title' => 'Content',
    'type' => MENU_DEFAULT_LOCAL_TASK,
    'weight' => -10,
  );

  $items['admin/config/content/tocbot'] = array(
    'title' => 'Tocbot Configuration',
    'page callback' => 'drupal_get_form',
    'page arguments'  => array('tocbot_config_form'),
    'access arguments' => array('administer site configuration'),
    'type' => MENU_LOCAL_TASK,
    'weight' => -9,
  );

  return $items;
}

/**
 * Implements hook_help().
 */
function tocbot_help($path, $arg) {
  switch ($path) {
    case 'admin/help#tocbot':

      $filepath = dirname(__FILE__) . '/README.md';
      if (file_exists($filepath)) {
        $readme = file_get_contents($filepath);
      }
      else {
        $filepath = dirname(__FILE__) . '/README.txt';
        if (file_exists($filepath)) {
          $readme = file_get_contents($filepath);
        }
      }
      if (!isset($readme)) {
        return NULL;
      }
      if (module_exists('markdown')) {
        $filters = module_invoke('markdown', 'filter_info');
        $info = $filters['filter_markdown'];

        if (function_exists($info['process callback'])) {
          $output = $info['process callback']($readme, NULL);
        }
        else {
          $output = '<pre>' . $readme . '</pre>';
        }
      }
      else {
        $output = '<pre>' . $readme . '</pre>';
      }

      return $output;
  }
}

/**
 * Configuration form to update module settings
 */
function tocbot_config_form($form, $form_state) {

  $form['moduleSettings'] = array(
    '#type' => 'fieldset',
    '#title' => t('Module Settings'),
    '#description' => t('Module settings to customize tocbot.'),
    '#collapsible' => FALSE,
    '#collapsed' => FALSE,
  );
  $form['moduleSettings']['tocbot_extrabodyclass'] = [
    '#type' => 'textfield',
    '#title' => t('Extra Body Class on Activation'),
    '#description' => t('When the tocbot is activated you can add an extra class
     to the body to adjust the theme of your site if desired. Leave blank if you
      dont need this.'),
    '#default_value' => variable_get('tocbot_extrabodyclass', 'toc-is-active'),
  ];
  $form['moduleSettings']['tocbot_tocTitle'] = [
    '#type' => 'textfield',
    '#title' => t('tocTitle'),
    '#description' => t('An optional title for the TOC, leave blank for none.
    Will be an strong tag with class <code>toc-title</code> so you can theme it'),
    '#default_value' => variable_get('tocbot_tocTitle', 'Page Outline:'),
  ];
  $form['moduleSettings']['tocbot_minActivate'] = [
    '#type' => 'textfield',
    '#title' => t('minActivate (number)'),
    '#description' => t('Only activate if greater than or equal to this many
    headings'),
    '#default_value' => variable_get('tocbot_minActivate', '3'),
  ];

  // Tocbot Settings tab
  $form['tocbot_jsSettings'] = array(
    '#type' => 'fieldset',
    '#title' => t('TocBot JS Settings'),
    '#description' => t('Tocbot API settings passed to javascript
    <a href="https://tscanlin.github.io/tocbot/#api">See API for details</a>.'),
    '#collapsible' => FALSE,
    '#collapsed' => FALSE,
  );
  $form['tocbot_jsSettings']['tocbot_tocSelector'] = [
    '#type' => 'textfield',
    '#title' => t('tocSelector'),
    '#description' => t('Where to render the table of contents. Place an empty
    div with a unique class into your theme template or use this block itself
    by settings it to <code>.js-toc-block</code>.'),
    '#default_value' => variable_get('tocbot_tocSelector', '.js-toc-block'),
  ];
  $form['tocbot_jsSettings']['tocbot_contentSelector'] = [
    '#type' => 'textfield',
    '#title' => t('contentSelector'),
    '#description' => t('Where to grab the headings to build the table of
    contents.'),
    '#default_value' => variable_get('tocbot_contentSelector', '#main-content'),
  ];
  $form['tocbot_jsSettings']['tocbot_headingSelector'] = [
    '#type' => 'textfield',
    '#title' => t('headingSelector'),
    '#description' => t('Where to grab the headings to build the table of contents.
    Comma and space seperated <code>h2, h3, h4, h5, h6</code>'),
    '#default_value' => variable_get('tocbot_headingSelector', 'h2, h3, h4, h5, h6'),
  ];
  $form['tocbot_jsSettings']['tocbot_ignoreSelector'] = [
    '#type' => 'textfield',
    '#title' => t('ignoreSelector'),
    '#description' => t('Headings that match the ignoreSelector will be skipped.'),
    '#default_value' => variable_get('tocbot_ignoreSelector', '.js-toc-ignore'),
  ];
  $form['tocbot_jsSettings']['tocbot_linkClass'] = [
    '#type' => 'textfield',
    '#title' => t('linkClass'),
    '#description' => t('Main class to add to links.'),
    '#default_value' => variable_get('tocbot_linkClass', 'toc-link'),
  ];
  $form['tocbot_jsSettings']['tocbot_extraLinkClasses'] = [
    '#type' => 'textfield',
    '#title' => t('extraLinkClasses'),
    '#description' => t('Extra classes to add to links.'),
    '#default_value' => variable_get('tocbot_extraLinkClasses', ''),
  ];
  $form['tocbot_jsSettings']['tocbot_activeLinkClass'] = [
    '#type' => 'textfield',
    '#title' => t('activeLinkClass'),
    '#description' => t('Class to add to active links, the link corresponding
    to the top most heading on the page.'),
    '#default_value' => variable_get('tocbot_activeLinkClass', 'is-active-link'),
  ];
  $form['tocbot_jsSettings']['tocbot_listClass'] = [
    '#type' => 'textfield',
    '#title' => t('listClass'),
    '#description' => t('Main class to add to lists.'),
    '#default_value' => variable_get('tocbot_listClass', 'toc-list'),
  ];
  $form['tocbot_jsSettings']['tocbot_extraListClasses'] = [
    '#type' => 'textfield',
    '#title' => t('extraListClasses'),
    '#description' => t('Extra classes to add to lists.'),
    '#default_value' => variable_get('tocbot_extraListClasses', ''),
  ];
  $form['tocbot_jsSettings']['tocbot_isCollapsedClass'] = [
    '#type' => 'textfield',
    '#title' => t('isCollapsedClass'),
    '#description' => t('Class that gets added when a list should be collapsed.'),
    '#default_value' => variable_get('tocbot_isCollapsedClass', 'is-collapsed'),
  ];
  $form['tocbot_jsSettings']['tocbot_collapsibleClass'] = [
    '#type' => 'textfield',
    '#title' => t('collapsibleClass'),
    '#description' => t('Class that gets added when a list should be able to be
    collapsed but isn\'t necessarily collapsed.'),
    '#default_value' => variable_get('tocbot_collapsibleClass', 'is-collapsible'),
  ];
  $form['tocbot_jsSettings']['tocbot_listItemClass'] = [
    '#type' => 'textfield',
    '#title' => t('listItemClass'),
    '#description' => t('Class to add to list items.'),
    '#default_value' => variable_get('tocbot_listItemClass', 'toc-list-item'),
  ];
  $form['tocbot_jsSettings']['tocbot_collapseDepth'] = [
    '#type' => 'textfield',
    '#title' => t('collapseDepth (number)'),
    '#description' => t('Class to add to list items.'),
    '#default_value' => variable_get('tocbot_collapseDepth', '0'),
  ];
  $form['tocbot_jsSettings']['tocbot_orderedList'] = [
    '#type' => 'checkbox',
    '#title' => t('orderedList'),
    '#description' => t('OrderedList can be set to false to generate unordered
    lists (ul) instead of ordered lists (ol).'),
    '#default_value' => variable_get('tocbot_orderedList', 0),
  ];
  $form['tocbot_jsSettings']['tocbot_scrollSmooth'] = [
    '#type' => 'checkbox',
    '#title' => t('scrollSmooth'),
    '#description' => t('Smooth scrolling enabled.'),
    '#default_value' => variable_get('tocbot_scrollSmooth', 1),
  ];
  $form['tocbot_jsSettings']['tocbot_scrollSmoothDuration'] = [
    '#type' => 'textfield',
    '#title' => t('scrollSmoothDuration (number)'),
    '#description' => t('Smooth scroll duration.'),
    '#default_value' => variable_get('tocbot_scrollSmoothDuration', '420'),
  ];
  $form['tocbot_jsSettings']['tocbot_throttleTimeout'] = [
    '#type' => 'textfield',
    '#title' => t('throttleTimeout (number)'),
    '#description' => t('Timeout between events firing to make sure its not too
    rapid (for performance reasons)'),
    '#default_value' => variable_get('tocbot_throttleTimeout', '50'),
  ];
  $form['tocbot_jsSettings']['tocbot_positionFixedSelector'] = [
    '#type' => 'textfield',
    '#title' => t('positionFixedSelector'),
    '#description' => t('Element to add the positionFixedClass to.'),
    '#default_value' => variable_get('tocbot_positionFixedSelector', '.js-toc'),
  ];
  $form['tocbot_jsSettings']['tocbot_positionFixedClass'] = [
    '#type' => 'textfield',
    '#title' => t('positionFixedClass'),
    '#description' => t('Fixed position class to add to make sidebar fixed after
    scrolling down past the fixedSidebarOffset.'),
    '#default_value' => variable_get('tocbot_positionFixedClass', 'is-position-fixed'),
  ];
  $form['tocbot_jsSettings']['tocbot_fixedSidebarOffset'] = [
    '#type' => 'textfield',
    '#title' => t('fixedSidebarOffset'),
    '#description' => t('fixedSidebarOffset can be any number but by default
    is set to auto which sets the fixedSidebarOffset to the sidebar elements
    offsetTop from the top of the document on init.'),
    '#default_value' => variable_get('tocbot_fixedSidebarOffset', 'auto'),
  ];
  $form['tocbot_jsSettings']['tocbot_includeHtml'] = [
    '#type' => 'checkbox',
    '#title' => t('includeHtml'),
    '#description' => t('includeHtml can be set to true to include the HTML
    markup from the heading node instead of just including the textContent.'),
    '#default_value' => variable_get('tocbot_includeHtml', 0),
  ];

  $form['actions']['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Save'),
  );
  return $form;
}

/**
 * Save Configuration form
 */
function tocbot_config_form_submit($form, $form_state) {

  $fieldsToSave = [
    'tocbot_extrabodyclass',
    'tocbot_tocTitle',
    'tocbot_minActivate',
    'tocbot_tocSelector',
    'tocbot_contentSelector',
    'tocbot_headingSelector',
    'tocbot_ignoreSelector',
    'tocbot_linkClass',
    'tocbot_extraLinkClasses',
    'tocbot_activeLinkClass',
    'tocbot_listClass',
    'tocbot_extraListClasses',
    'tocbot_isCollapsedClass',
    'tocbot_collapsibleClass',
    'tocbot_listItemClass',
    'tocbot_collapseDepth',
    'tocbot_orderedList',
    'tocbot_scrollSmooth',
    'tocbot_scrollSmoothDuration',
    'tocbot_throttleTimeout',
    'tocbot_positionFixedSelector',
    'tocbot_positionFixedClass',
    'tocbot_fixedSidebarOffset',
  ];

  foreach ($fieldsToSave as $value) {
    $formValue = $form_state['values'][$value];
    variable_set($value, $formValue);
  }
}

/**
 * Implements hook_libraries_info().
 *
 * For defining external libraries.
 */
function tocbot_libraries_info() {

  // A very simple library.
  // Expected to be extracted into 'sites/all/libraries/tocbot'.
  $libraries['tocbot'] = array(
    'name' => 'tocbot',
    'vendor url' => 'https://tscanlin.github.io/tocbot/',
    'download url' => 'https://github.com/tscanlin/tocbot/releases/',
    'version' => '4.3.1',
    'path' => 'tocbot',
    'files' => array(
      'js' => array('tocbot.min.js'),
      'css' => array('tocbot.css'),
    ),
  );

  return $libraries;
}

/**
 * Implements hook_block_info().
 */
function tocbot_block_info() {

  $blocks = array();
  $blocks['tocbot_block'] = array(
    'info' => t('tocbot block'),
  );

  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function tocbot_block_view($delta = '') {
  $settings = [];

  // Gather settings to send to tocbot-init
  $settings['extrabodyclass'] = variable_get('tocbot_extrabodyclass', 'toc-is-active');
  $settings['tocTitle'] = variable_get('tocbot_tocTitle', 'Page Outline:');
  $settings['minActivate'] = intval(variable_get('tocbot_minActivate', '3'));
  $settings['options']['tocSelector'] = variable_get('tocbot_tocSelector', '.js-toc-block');
  $settings['options']['contentSelector'] = variable_get('tocbot_contentSelector', '#main-content');
  $settings['options']['headingSelector'] = variable_get('tocbot_headingSelector', 'h2, h3, h4, h5, h6');
  $settings['options']['ignoreSelector'] = variable_get('tocbot_ignoreSelector', '.js-toc-ignore');
  $settings['options']['linkClass'] = variable_get('tocbot_linkClass', 'toc-link');
  $settings['options']['extraLinkClasses'] = variable_get('tocbot_extraLinkClasses', '');
  $settings['options']['activeLinkClass'] = variable_get('tocbot_activeLinkClass', 'is-active-link');
  $settings['options']['listClass'] = variable_get('tocbot_listClass', 'toc-list');
  $settings['options']['extraListClasses'] = variable_get('tocbot_extraListClasses', '');
  $settings['options']['isCollapsedClass'] = variable_get('tocbot_isCollapsedClass', 'is-collapsed');
  $settings['options']['collapsibleClass'] = variable_get('tocbot_collapsibleClass', 'is-collapsible');
  $settings['options']['listItemClass'] = variable_get('tocbot_listItemClass', 'toc-list-item');
  $settings['options']['collapseDepth'] = intval(variable_get('tocbot_collapseDepth', '0'));
  $settings['options']['orderedList'] = variable_get('tocbot_orderedList', 0);
  $settings['options']['scrollSmooth'] = variable_get('tocbot_scrollSmooth', 1);
  $settings['options']['scrollSmoothDuration'] = intval(variable_get('tocbot_scrollSmoothDuration', '420'));
  $settings['options']['throttleTimeout'] = intval(variable_get('tocbot_throttleTimeout', '50'));
  $settings['options']['positionFixedSelector'] = variable_get('tocbot_positionFixedSelector', '.js-toc');
  $settings['options']['positionFixedClass'] = variable_get('tocbot_positionFixedClass', 'is-position-fixed');
  $settings['options']['fixedSidebarOffset'] = variable_get('tocbot_fixedSidebarOffset', 'auto');
  $settings['options']['includeHtml'] = variable_get('tocbot_includeHtml', 0);

  $attached = array();

  // load library
  if (file_exists(libraries_get_path('tocbot') . '/sites/all/libraries/tocbot/js/tocbot.min.js')) {
    $attached['js'] = array(
      libraries_get_path('tocbot') . '/sites/all/libraries/tocbot/js/tocbot.min.js' => array(
        'weight' => -20,
      )
    );
  }
  else {
    $attached['js'] = array(
      "https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js" => array(
        'type' => 'external',
        'weight' => -20,
      )
    );
  }
  // load css
  if (file_exists(libraries_get_path('tocbot') . '/sites/all/libraries/tocbot/css/tocbot.css')) {
    $attached['css'] = array(
      libraries_get_path('tocbot') . '/sites/all/libraries/tocbot/css/tocbot.css' => array(
        'weight' => -20,
      )
    );
  }
  else {
    $attached['css'] = array(
      'https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css' => array(
        'type' => 'external',
        'weight' => -20,
      )
  );
  }

  $attached['js'][drupal_get_path('module', 'tocbot') . '/js/tocbot-init.js'] = array(
    'scope' => 'footer',
    'weight' => 5,
  );

  //Send settings to Javascript
  $attached['js'][] = array('data' => array('tocbot' => $settings), 'type' => 'setting');

  $block = array();

  switch ($delta) {
    case 'tocbot_block':
      $block['content'] = array(
        '#markup' => tocbot_content(),
        '#attached' => $attached
      );
      break;
  }

  return $block;
}

/**
 * Implements hook_content().
 */
function tocbot_content() {
  return '<div class="js-toc-block-wrapper"><div class="js-toc-block"></div></div>';
}
